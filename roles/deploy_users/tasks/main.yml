---
- name: Ensure sudo group exists
  ansible.builtin.group:
    name: sudo
    state: present

- name: Create users
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ item.groups }}"
    shell: "{{ item.shell }}"
    create_home: true
    state: present
  loop: "{{ users }}"

- name: Set up authorized keys for users
  ansible.posix.authorized_key:
    user: "{{ item.name }}"
    key: "{{ item.ssh_key }}"
    state: present
  loop: "{{ users }}"

- name: Ensure .ssh directory permissions are correct
  ansible.builtin.file:
    path: "/home/{{ item.name }}/.ssh"
    state: directory
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0700'
  loop: "{{ users }}"

- name: Ensure authorized_keys permissions are correct
  ansible.builtin.file:
    path: "/home/{{ item.name }}/.ssh/authorized_keys"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0600'
  loop: "{{ users }}"

- name: Set password for deploy user
  ansible.builtin.user:
    name: deploy
    password: "{{ deploy_pw | password_hash('sha512') }}"
    update_password: always
  when: deploy_pw is defined
